<!DOCTYPE html><html lang="pt-br">
<head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>RS TECH</title>    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">    <style>
        :root {
            --c-cyan: #19fff7;
            --c-green: #46ff86;
            --c-yellow: #ffe066;
            --c-blue: #02a6ff;
            --c-purple: #977cff;
            --c-bg-dark: #16271d;
            --c-bg-card: #193c2c;
            --txt: #eaffea;
            --tit: 'Orbitron', Arial, sans-serif;
            --bod: 'Share Tech Mono', monospace;
        }

        body {
            background: linear-gradient(120deg, #16271d 0%, #1b3440 100%);
            color: var(--txt);
            font-family: var(--bod);
            margin: 0;
            padding: 0 0 0 70px;
            min-height: 100vh;
            box-sizing: border-box;
            position: relative;
            overflow-x: hidden;
        }

        header {
            background: transparent;
            color: var(--c-green);
            text-align: center;
            padding: 2.2rem 1rem 1.2rem 1rem;
            font-family: var(--tit);
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 0 2px 12px var(--c-cyan);
            border-bottom: 3px solid var(--c-cyan);
            z-index: 10;
            position: relative;
        }

        .atalhos-lateral {
            position: fixed;
            top: 0;
            left: 0;
            width: 70px;
            height: 100svh;
            background: #153826;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            z-index: 101;
            box-shadow: 2px 0 14px #19fff733;
            padding-top: 0.4rem;
            padding-bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
            border-right: 2px solid var(--c-green);
            scrollbar-width: thin;
            scrollbar-color: var(--c-green) #153826;
            overscroll-behavior-y: contain;
            box-sizing: border-box;
        }

        .atalhos-lateral .ataho-link {
            width: 44px;
            height: 44px;
            margin: 0.1rem 0;
            background: #143a22;
            color: var(--c-cyan);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 1.22rem;
            border: 1.5px solid transparent;
            transition: border .2s, color .2s, box-shadow .2s, transform .2s;
            outline: none;
            flex-shrink: 0;
        }

        .atalhos-lateral .ataho-link:focus {
            outline: 2px solid var(--c-yellow);
            outline-offset: 2px;
        }

        .atalhos-lateral .ataho-link:hover,
        .atalhos-lateral .ataho-link:focus {
            color: var(--c-yellow);
            border: 1.5px solid var(--c-yellow);
            box-shadow: 0 0 10px var(--c-yellow);
            transform: scale(1.1);
        }

        .atalhos-lateral .ataho-link.active {
            color: var(--c-green);
            border: 1.5px solid var(--c-green);
            box-shadow: 0 0 14px var(--c-green);
        }

        .atalhos-lateral::-webkit-scrollbar {
            width: 8px;
            background: #153826;
        }

        .atalhos-lateral::-webkit-scrollbar-thumb {
            background: var(--c-green);
            border-radius: 4px;
        }

        @media (max-width: 800px) {
            .atalhos-lateral {
                width: 54px;
                gap: 0.2rem;
                padding-top: 0.2rem;
            }

            body {
                padding-left: 54px;
            }

            .atalhos-lateral .ataho-link {
                width: 36px;
                height: 36px;
                margin: 0.05rem 0;
                font-size: 1.1rem;
            }
        }

        @media (max-width: 600px) {
            .atalhos-lateral {
                width: 50px;
                gap: 0.1rem;
                padding-top: 0.1rem;
            }

            body {
                padding-left: 50px;
            }

            .atalhos-lateral .ataho-link {
                width: 30px;
                height: 30px;
                margin: 0;
                font-size: 1rem;
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            padding: 2rem 2vw 1rem 2vw;
            max-width: 1440px;
            margin: auto;
            box-sizing: border-box;
        }

        @media (max-width: 1100px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1.1rem;
            }

            .card.anotacoes-rapidas {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 799px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.1rem;
            }

            .card.anotacoes-rapidas {
                grid-column: auto;
            }
        }

        @media (max-width: 599px) {
            .dashboard-grid {
                gap: 0.5rem;
                padding: 0.5rem 0.1rem;
            }
        }

        .card {
            background: var(--c-bg-card);
            border-radius: 1.5rem;
            box-shadow: 0 2px 18px #19fff733;
            padding: 1.4rem 1.1rem 1.1rem 1.1rem;
            display: flex;
            flex-direction: column;
            min-width: 220px;
            max-width: 100%;
            min-height: 340px;
            margin-bottom: 0.5rem;
            border: 2px solid var(--c-green);
            transition: border .16s, box-shadow .14s;
            overflow: visible;
            box-sizing: border-box;
            position: relative;
        }

        .card.anotacoes-rapidas {
            grid-column: 1 / -1;
        }

        .card h2 {
            font-family: var(--tit);
            font-size: 1.14rem;
            color: var(--c-cyan);
            letter-spacing: 1px;
            margin: 0 0 1rem 0;
            text-align: center;
            border-bottom: 1.5px solid var(--c-yellow);
            padding-bottom: 0.5rem;
            flex-shrink: 0;
            width: 100%; /* Garante que o h2 ocupe a largura para text-align funcionar bem */
        }

        .card form {
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .card textarea,
        .card input,
        .card select {
            width: 100%;
            box-sizing: border-box;
        }

        input,
        textarea,
        select {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            display: block;
            border-radius: 0.7rem;
            background: #163221;
            color: var(--txt);
            border: 1.5px solid var(--c-green);
            padding: 0.8rem 1rem;
            margin: 0.2rem 0 0.6rem 0;
            font-size: 1.06rem;
            font-family: var(--bod);
            transition: border 0.13s;
            outline: none;
            word-break: break-all;
        }

        .diario-btns,
        .aluno-form-actions-wrapper,
        .financeiro-form-actions-wrapper,
        .anotacoes-form-actions-wrapper {
            display: flex;
            justify-content: center;
            gap: 0.7rem;
            flex-wrap: wrap;
            margin-top: auto;
            padding-top: 0.5rem;
            flex-shrink: 0;
        }

        .alunos-btns {
            display: flex;
            justify-content: center;
            gap: 0.7rem;
        }

        .cadastro-alunos .btn {
            min-width: 120px;
        }

        .search-results-container {
            position: relative;
        }

        .search-results-list {
            position: absolute;
            width: calc(100% - 2px);
            max-height: 150px;
            overflow-y: auto;
            background: #102b1f;
            border: 1px solid var(--c-green);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            margin-top: -0.6rem;
            z-index: 100;
            box-sizing: border-box;
        }

        .search-results-list div {
            padding: 0.6rem 1rem;
            cursor: pointer;
            color: var(--txt);
            border-bottom: 1px solid #163221;
            font-size: 0.95rem;
        }

        .search-results-list div:last-child {
            border-bottom: none;
        }

        .search-results-list div:hover {
            background-color: #193c2c;
            color: var(--c-yellow);
        }

        .search-results-list:empty {
            display: none;
        }

        textarea {
            resize: vertical;
            min-height: 74px;
            max-height: 220px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border: 1.5px solid var(--c-yellow);
        }

        .card form .btn {
            margin-right: 0.3rem;
            margin-left: 0.3rem;
            margin-bottom: 0.4rem;
        }

        .card form .btn:first-child {
            margin-left: 0;
        }

        .card form .btn:last-child {
            margin-right: 0;
        }

        .table-actions button {
            background: none;
            border: none;
            color: var(--c-green);
            font-size: 1.13rem;
            cursor: pointer;
            transition: color 0.14s;
            padding: 0.2rem 0.3rem;
        }

        .table-actions button:hover {
            color: var(--c-yellow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #133829;
            color: var(--txt);
            border-radius: 1rem;
            margin-bottom: 1rem;
            font-size: 0.97rem;
            box-shadow: 0 1px 6px #19fff722;
            overflow: hidden; /* Ajuda com border-radius em tabelas */
            box-sizing: border-box;
        }

        table th,
        table td {
            padding: 0.6rem 0.4rem;
            text-align: left; /* Padrão para todas as tabelas */
            border-bottom: 1px solid #263b2b;
        }

        /* Centraliza a coluna "Anotação" na tabela de Anotações Rápidas */
        #tabelaAnotacoes th:first-child,
        #tabelaAnotacoes td:first-child {
            text-align: center;
        }
        
        /* A coluna "Ações" é centralizada por estilos inline na TH e pela classe .table-actions + estilo inline na TD gerada por JS */
        /* Para consistência, poderia ser uma classe:
        .coluna-acoes { text-align: center; width: 100px; }
        E aplicar essa classe na th e td correspondentes.
        */

        table th { /* Estilo geral para cabeçalhos de tabela */
            color: var(--c-green);
            font-family: var(--tit);
            border-bottom: 2px solid var(--c-cyan);
        }

        .portal-acesso {
            background: transparent;
            color: var(--c-green);
            border-radius: 1.2rem;
            border: 2px solid var(--c-cyan);
            font-family: var(--tit);
            text-align: center;
            font-size: 1.08rem;
            font-weight: bold;
            box-shadow: 0 2px 12px #19fff733;
            padding: 2rem 1rem;
            margin: 2rem auto 1.5rem auto;
            max-width: 700px;
            transition: border .19s, color .19s;
            cursor: pointer;
            text-decoration: none;
            letter-spacing: 1.15px;
            display: block;
        }

        .portal-acesso:hover {
            color: var(--c-yellow);
            border-color: var(--c-yellow);
        }

        .main-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2.1rem;
            margin: 2.5rem auto 0 auto;
            padding-bottom: calc(2.8rem + 1.5rem);
            max-width: 700px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn,
        .btn-export,
        .btn-import {
            background: transparent;
            color: var(--c-cyan);
            font-family: var(--tit);
            border: 1.5px solid var(--c-cyan);
            border-radius: 1.1rem;
            padding: 0.7rem 1.6rem;
            font-size: 1.06rem;
            font-weight: bold;
            cursor: pointer;
            transition: border .14s, color .14s, background .14s;
            margin-top: 0.2rem;
            min-width: 100px;
            text-align: center;
        }

        .btn:hover,
        .btn-export:hover,
        .btn-import:hover {
            color: var(--c-green);
            border: 1.5px solid var(--c-green);
            background: #1d342a;
        }

        .financeiro-mes-selector .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            min-width: auto;
        }

        footer {
            width: 100%;
            text-align: center;
            color: #5beebb;
            font-size: 1.1rem;
            font-family: var(--tit);
            letter-spacing: 0.2em;
            background: #133829ea;
            padding: 0.85rem 0;
            position: relative; /* Changed from fixed/absolute for simplicity if not strictly needed at bottom of viewport always */
            bottom: 0;
            z-index: 100;
            opacity: 0.85;
            user-select: none;
            box-shadow: 0 -2px 8px #16271d77;
            box-sizing: border-box;
            margin-left: -70px; /* Matches body padding-left */
        }

        @media (max-width: 800px) {
            footer {
                margin-left: -54px;
            }
        }

        @media (max-width: 600px) {
            footer {
                margin-left: -50px;
            }
        }


        @media (max-width: 600px) {
            .main-controls {
                flex-direction: column;
                gap: 1.2rem;
                padding-bottom: calc(2.29rem + 1rem);
            }

            .portal-acesso {
                font-size: 1rem;
                padding: 1.3rem 0.6rem;
            }

            footer {
                font-size: 0.99rem;
                padding: 0.65rem 0;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 1.1rem 0.2rem 0.8rem 0.2rem;
            }

            .dashboard-grid {
                padding: 0.6rem 0.1rem;
            }

            .main-controls {
                padding-bottom: calc(2.29rem + 2rem);
            }
        }

        .modal-bg {
            display: none;
            position: fixed;
            z-index: 1010;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 32, 32, 0.72);
            justify-content: center;
            align-items: flex-start; /* Changed to flex-start to allow scroll for tall modals */
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto; /* Allows scrolling of the modal background if modal is too tall */
        }

        .modal-bg.active {
            display: flex;
        }

        .modal-diario,
        .modal-financeiro,
        .modal-alunos {
            background: #122921;
            color: var(--txt);
            border-radius: 1.1rem;
            box-shadow: 0 8px 34px #1beeea66;
            padding: 1.5rem;
            width: 100%;
            max-width: 800px;
            max-height: calc(100vh - 2rem); /* Max height relative to viewport */
            font-family: var(--bod);
            font-size: 1.13rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
            box-sizing: border-box;
            margin-top: 2rem; /* Added margin for better spacing when align-items: flex-start */
            margin-bottom: 2rem; /* Added margin for better spacing */
        }

        .modal-diario h3,
        .modal-financeiro h3,
        .modal-alunos h3 {
            margin: 0 0 0.5rem 0;
            text-align: center;
            font-family: var(--tit);
            color: var(--c-cyan);
            flex-shrink: 0;
        }

        .modal-diario .fechar-modal,
        .modal-financeiro .fechar-modal,
        .modal-alunos .fechar-modal {
            position: absolute;
            right: 18px;
            top: 12px;
            background: none;
            border: none;
            color: var(--c-yellow);
            font-size: 1.3rem;
            cursor: pointer;
            font-family: var(--tit);
            z-index: 10;
        }

        .table-container-modal {
            flex-grow: 1;
            min-height: 0; /* Important for flex item with overflow */
            overflow-y: auto;
            overscroll-behavior-y: contain;
            border-radius: 0.8rem;
            background: #133829;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            padding-top: 0.2rem; /* Reduced padding if sticky header is used */
            padding-left: 0.2rem;
            padding-right: 0.2rem;
            padding-bottom: 2rem; /* Space for content at the bottom */
            box-sizing: border-box;
        }

        .table-container-modal table {
            width: 100%;
            font-size: 1.0rem;
            border-collapse: separate; /* separate for border-spacing if needed, or stick to collapse */
            border-spacing: 0;
        }

        .table-container-modal th,
        .table-container-modal td {
            padding: 0.5rem;
            border-bottom: 1px solid #263b2b;
            text-align: center;
            vertical-align: middle;
        }
        .table-container-modal td:first-child, /* Alinhamento da primeira coluna do modal */
        .table-container-modal th:first-child {
            text-align: left;
            padding-left: 1rem;
        }


        .table-container-modal th {
            color: var(--c-green);
            font-family: var(--tit);
            border-bottom: 2px solid var(--c-cyan);
            position: sticky;
            top: -1px; /* Adjust if padding-top on container changes */
            background: #133829; /* Match container background */
            z-index: 1;
        }
        .table-container-modal tr:last-child td {
            border-bottom: none;
        }


        .modal-diario-table { /* Specific for diario, if different styling is needed */
            width: 100%;
            overflow-y: auto;
            overscroll-behavior-y: contain;
            border-radius: 1rem;
            background: #163221; /* Different background for diario modal table */
            box-shadow: 0 1px 8px #19fff744;
            flex-grow: 1;
            min-height: 0;
            box-sizing: border-box;
            padding-bottom: 2rem;
        }

        .modal-diario-table table {
            width: 100%;
            font-size: 1.01rem;
            border-collapse: separate;
            border-spacing: 0;
        }

        .modal-diario-table th,
        .modal-diario-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #263b2b;
            text-align: left; /* Default for diario table */
            vertical-align: middle;
        }
         .modal-diario-table th {
            color: var(--c-green);
            font-family: var(--tit);
            border-bottom: 2px solid var(--c-cyan);
            position: sticky;
            top: -1px;
            background: #163221; /* Match diario table background */
            z-index: 1;
        }
        .modal-diario-table td.table-actions { /* Actions column in diario table */
            text-align: center;
        }

        .modal-diario-table tr:last-child td {
            border-bottom: none;
        }
        .modal-diario-table td {
            color: #def2e1;
            word-break: break-word;
        }


        .modal-diario-filtro {
            display: flex;
            flex-wrap: wrap;
            gap: 0.7rem;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .modal-diario-filtro label {
            font-size: 1.02rem;
            color: #9cf7ee;
            font-family: var(--bod);
            margin-bottom: 0.1rem; /* Align with input baseline */
            margin-right: 0.4rem;
        }

        .modal-diario-filtro input[type="text"],
        .modal-diario-filtro input[type="date"] {
            background: #193c2c;
            border: 1.2px solid var(--c-green);
            color: #d3fff3;
            padding: 0.5rem 0.7rem;
            border-radius: 0.7rem;
            font-size: 0.98rem;
            font-family: var(--bod);
            outline: none;
            margin-right: 1rem; /* spacing */
        }
        .modal-diario-filtro input[type="text"]:focus,
        .modal-diario-filtro input[type="date"]:focus {
            border-color: var(--c-cyan);
        }


        .financeiro-mes-selector {
            display: flex;
            gap: 10px; /* spacing between items */
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap; /* allow wrapping on small screens */
            flex-shrink: 0;
        }
        .financeiro-mes-selector label {
            font-size: 1.02rem;
            color: #9cf7ee;
            margin-right: 5px; /* spacing */
        }
        .financeiro-mes-selector select {
            background: #193c2c;
            border: 1.2px solid var(--c-green);
            color: #d3fff3;
            padding: 0.5rem 0.7rem;
            border-radius: 0.7rem;
            font-size: 0.98rem;
            font-family: var(--bod);
            outline: none;
            flex-grow: 1; /* allow select to grow */
            min-width: 130px; /* minimum width */
            margin-right: 5px; /* spacing */
        }
         .financeiro-mes-selector .btn { /* Reuses .btn, could be .btn-sm if defined elsewhere */
            padding: 0.5rem 0.8rem;
            font-size: 0.95rem;
            min-width: auto; /* override .btn min-width if necessary */
            flex-shrink: 0; /* prevent buttons from shrinking */
         }
    </style>
</head>
<body>
    <nav class="atalhos-lateral" aria-label="Atalhos Rápidos">
        <a href="https://classroom.google.com/" target="_blank" class="ataho-link" title="Google Classroom" tabindex="1" aria-label="Google Classroom"><i class="fab fa-google"></i></a>
        <a href="https://meet.google.com/" target="_blank" class="ataho-link" title="Google Meet" tabindex="2" aria-label="Google Meet"><i class="fas fa-video"></i></a>
        <a href="https://drive.google.com/" target="_blank" class="ataho-link" title="Google Drive" tabindex="3" aria-label="Google Drive"><i class="fab fa-google-drive"></i></a>
        <a href="https://docs.google.com/" target="_blank" class="ataho-link" title="Google Docs" tabindex="4" aria-label="Google Docs"><i class="far fa-file-alt"></i></a>
        <a href="https://sheets.google.com/" target="_blank" class="ataho-link" title="Google Planilhas" tabindex="5" aria-label="Google Planilhas"><i class="fas fa-table"></i></a>
        <a href="https://calendar.google.com/" target="_blank" class="ataho-link" title="Google Agenda" tabindex="6" aria-label="Google Agenda"><i class="far fa-calendar-alt"></i></a>
        <a href="https://slides.google.com/" target="_blank" class="ataho-link" title="Google Apresentações" tabindex="7" aria-label="Google Apresentações"><i class="fas fa-chalkboard"></i></a>
        <a href="https://fast.com/" target="_blank" class="ataho-link" title="Teste de Velocidade (Fast)" tabindex="8" aria-label="Teste de Velocidade"><i class="fas fa-laptop"></i></a>
        <a href="https://convertio.co/pt/" target="_blank" class="ataho-link" title="Convertio" tabindex="9" aria-label="Convertio"><i class="fas fa-globe"></i></a>
        <a href="https://ravellsl.github.io/ferramenta-dev-links/" target="_blank" class="ataho-link" title="Dev Links" tabindex="10" aria-label="Dev Links"><i class="fas fa-code"></i></a>
        <a href="https://ravellsl.github.io/agentes-de-IA/" target="_blank" class="ataho-link" title="Agentes de IA" tabindex="11" aria-label="Agentes de IA"><i class="fas fa-robot"></i></a>
        <a href="https://www.videosmaller.com/pt/" target="_blank" class="ataho-link" title="Compressor de Vídeo" tabindex="12" aria-label="Compressor de Vídeo"><i class="fas fa-exchange-alt"></i></a>
        <a href="https://ravellsl.github.io/ferramenta-busca-noticias/" target="_blank" class="ataho-link" title="Notícias" tabindex="13" aria-label="Notícias"><i class="fas fa-newspaper"></i></a>
    </nav>

    <header>
        RS TECH
    </header>

    <main class="dashboard-grid">
        <div class="card diario-classe">
            <div style="display: flex; flex-direction: column; flex-grow: 1;">
                <h2>Diário de Classe</h2>
                <form id="formDiarioClasse" onsubmit="event.preventDefault();">
                    <input id="diarioAluno" type="text" placeholder="Nome do Aluno" autocomplete="off" required oninput="mostrarBotoesDiario()">
                    <input id="diarioData" type="date" required oninput="mostrarBotoesDiario()">
                    <textarea id="diarioConteudo" rows="4" placeholder="Conteúdo ministrado..." required oninput="mostrarBotoesDiario()"></textarea>
                    <div class="diario-btns">
                        <button class="btn" type="button" id="btnDiarioAdd" onclick="salvarDiarioClasse()" style="display:none;">Salvar</button>
                        <button class="btn" type="button" id="btnDiarioEdit" style="display:none;" onclick="confirmarEdicaoDiarioClasse()">Salvar Edição</button>
                        <button class="btn" type="button" id="btnDiarioCancel" style="display:none;" onclick="cancelarEdicaoDiarioClasse()">Cancelar</button>
                        <button class="btn" type="button" id="btnDiarioLimpar" onclick="limparCamposDiario()" style="display:none;">Limpar</button>
                    </div>
                </form>
            </div>
            <button class="btn" style="margin-top: 0.8rem; width:100%; flex-shrink: 0;" onclick="abrirModalDiario()">Visualizar Diário</button>
        </div>

        <div class="card cadastro-alunos">
            <div style="display: flex; flex-direction: column; flex-grow: 1;">
                <h2>Cadastro de Alunos (AnyDesk)</h2>
                <form onsubmit="event.preventDefault(); adicionarAluno();">
                    <div class="search-results-container">
                        <input id="nomeAluno" placeholder="Nome do Aluno (ou pesquise)" autocomplete="off" oninput="pesquisarAlunosNoCard(this.value); mostrarBotoesAluno();" onblur="setTimeout(limparResultadosPesquisaAlunos, 200);">
                        <div id="listaResultadosPesquisaAlunos" class="search-results-list"></div>
                    </div>
                    <input id="anydeskAluno" placeholder="AnyDesk do Aluno" autocomplete="off" oninput="mostrarBotoesAluno()">
                    <div class="aluno-form-actions-wrapper">
                        <div class="alunos-btns">
                            <button class="btn" type="submit" id="btnAlunoAdd" style="display:none;">Cadastrar</button>
                            <button class="btn" type="button" id="btnAlunoLimpar" style="display:none;" onclick="limparAlunoCamposComPesquisa()">Limpar Tudo</button>
                        </div>
                        <button class="btn" type="button" id="btnAlunoEdit" style="display:none;" onclick="confirmarEdicaoAluno()">Salvar Edição</button>
                        <button class="btn" type="button" id="btnAlunoCancel" style="display:none;" onclick="cancelarEdicaoAlunoComPesquisa()">Cancelar</button>
                    </div>
                </form>
            </div>
            <button class="btn" style="margin-top: 0.8rem; width:100%; flex-shrink: 0;" onclick="abrirModalAlunos()">Visualizar Alunos</button>
        </div>

        <div class="card controle-financeiro">
            <div style="display: flex; flex-direction: column; flex-grow: 1;">
                <h2>Controle Financeiro</h2>
                <form id="formFinanceiro" onsubmit="event.preventDefault(); adicionarFinanceiro();">
                    <input id="nomeFinanceiro" placeholder="Nome do Aluno/Descrição" autocomplete="off" oninput="mostrarBotoesFinanceiro()">
                    <input id="valorFinanceiro" type="number" placeholder="Valor (R$)" autocomplete="off" oninput="mostrarBotoesFinanceiro()" step="0.01">
                    <select id="statusFinanceiro" onchange="mostrarBotoesFinanceiro()">
                        <option value="Pago">Pago</option>
                        <option value="Pendente">Pendente</option>
                    </select>
                    <select id="tipoFinanceiro" onchange="mostrarBotoesFinanceiro()" style="margin-bottom:0.6rem;">
                        <option value="Mensalidade">Mensalidade</option>
                        <option value="Serviço Extra">Serviço Extra</option>
                        <option value="Outro">Outro</option>
                    </select>
                    <div class="financeiro-form-actions-wrapper">
                        <button class="btn" type="submit" id="btnFinAdd" style="display:none;">Lançar</button>
                        <button class="btn" type="button" id="btnFinEdit" style="display:none;" onclick="confirmarEdicaoFinanceiro()">Salvar Edição</button>
                        <button class="btn" type="button" id="btnFinCancel" style="display:none;" onclick="cancelarEdicaoFinanceiro()">Cancelar</button>
                        <button class="btn" type="button" id="btnFinLimpar" style="display:none;" onclick="limparFinanceiroCampos()">Limpar Tudo</button>
                    </div>
                </form>
            </div>
            <button class="btn" style="margin-top: 0.8rem; width:100%; flex-shrink: 0;" onclick="abrirModalFinanceiro()">Visualizar Dados</button>
        </div>

        <div class="card anotacoes-rapidas">
            <div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center;"> {/* Adicionado align-items: center */}
                <h2>Anotações Rápidas</h2>
                <form onsubmit="event.preventDefault(); salvarOuAtualizarAnotacao();" style="width: 100%;"> {/* Adicionado width: 100% */}
                    <input id="anotacaoInput" placeholder="Digite uma anotação rápida" autocomplete="off" oninput="mostrarBotoesAnotacao()">
                    <div class="anotacoes-form-actions-wrapper">
                        <button class="btn" type="submit" id="btnAddAnotacao" style="display:none;">Adicionar</button>
                        <button class="btn" type="button" id="btnEditAnotacao" style="display:none;" onclick="salvarOuAtualizarAnotacao()">Salvar Edição</button>
                        <button class="btn" type="button" id="btnCancelEditAnotacao" style="display:none;" onclick="cancelarEdicaoAnotacao()">Cancelar</button>
                        <button class="btn" type="button" id="btnLimparAnotacao" style="display:none;" onclick="limparAnotacaoCampos()">Limpar Tudo</button>
                    </div>
                </form>
                <table id="tabelaAnotacoes" style="margin-top:1rem; flex-grow: 1; overflow-y: auto; display: block; width: 100%;"> {/* Adicionado width: 100% */}
                    <thead>
                        <tr>
                            <th>Anotação</th> {/* Será centralizado por CSS #tabelaAnotacoes th:first-child */ }
                            <th style="width:100px; text-align:center;">Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>

    <a class="portal-acesso" href="https://ravellsl.github.io/rstech/" target="_blank">
        <i class="fas fa-external-link-alt"></i> ACESSO AO PORTAL PRINCIPAL
    </a>

    <div class="main-controls">
        <button class="btn-export" onclick="exportarDados()"><i class="fas fa-download"></i> Exportar Dados</button>
        <label class="btn-import" style="display:inline-block;cursor:pointer;">
            <i class="fas fa-upload"></i> Importar Dados
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDados(event)">
        </label>
    </div>

    <div class="modal-bg" id="modalDiario">
        <div class="modal-diario">
            <button class="fechar-modal" onclick="fecharModalDiario()" title="Fechar">&times;</button>
            <h3>Diário de Classe - Registros</h3>
            <div class="modal-diario-filtro">
                <label for="filtroNome">Aluno:</label>
                <input type="text" id="filtroNome" placeholder="Filtrar por nome">
                <label for="filtroData">Data:</label>
                <input type="date" id="filtroData">
            </div>
            <div class="modal-diario-table" id="conteudoModalDiario"></div>
        </div>
    </div>

    <div class="modal-bg" id="modalFinanceiro">
        <div class="modal-financeiro">
            <button class="fechar-modal" onclick="fecharModalFinanceiro()" title="Fechar">&times;</button>
            <h3>Controle Financeiro - Lançamentos</h3>
            <div class="financeiro-mes-selector">
                <label for="mesAnoSelectFinanceiro">Mês/Ano:</label>
                <select id="mesAnoSelectFinanceiro" onchange="atualizarModalFinanceiroComMesSelecionado()"></select>
                <button class="btn btn-sm" onclick="navegarMesFinanceiro(-1)" title="Mês Anterior"><i class="fas fa-chevron-left"></i></button>
                <button class="btn btn-sm" onclick="navegarMesFinanceiro(1)" title="Próximo Mês"><i class="fas fa-chevron-right"></i></button>
                <button class="btn btn-sm" onclick="irParaMesAtualFinanceiro()" title="Ir para Mês Atual">Mês Atual</button>
            </div>
            <div id="conteudoModalFinanceiro" class="table-container-modal">
                </div>
        </div>
    </div>

    <div class="modal-bg" id="modalAlunos">
        <div class="modal-alunos">
            <button class="fechar-modal" onclick="fecharModalAlunos()" title="Fechar">&times;</button>
            <h3>Alunos Cadastrados</h3>
            <div id="conteudoModalAlunos" class="table-container-modal">
            </div>
        </div>
    </div>

    <footer>
        RS TECH <span id="anoAtualFooter"></span>
    </footer>

    <script>
        // Utilitários de armazenamento
        function salvarLocal(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function recuperarLocal(key, fallback) {
            const item = localStorage.getItem(key);
            try {
                const parsedItem = item ? JSON.parse(item) : fallback;
                if (key === 'controleFinanceiro' && (parsedItem === null || Array.isArray(parsedItem))) { // Specific check for controleFinanceiro
                    return fallback; 
                }
                return parsedItem;
            } catch (e) {
                console.warn("Erro ao parsear JSON do localStorage para a chave:", key, e);
                return fallback;
            }
        }

        let diarioEditIdx = null;
        let finEditIdx = null; 
        let alunoEditIdx = null;
        let anotacaoEditIdx = null;
        let financeiroSelecionadoMesAno = ''; // Stores 'YYYY-MM'

        function formatarMoeda(valor) {
            const numero = parseFloat(valor) || 0;
            return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function getFormattedMonthYear(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${year}-${month}`;
        }

        function getCurrentMonthYearKey() {
            return getFormattedMonthYear(new Date());
        }
        
        function parseMonthYearKey(monthYearKey) { // 'YYYY-MM'
            const parts = monthYearKey.split('-');
            return { year: parseInt(parts[0]), month: parseInt(parts[1]) };
        }

        function monthYearKeyToDisplay(monthYearKey) { // 'YYYY-MM' to 'MM/YYYY'
             if (!monthYearKey || typeof monthYearKey !== 'string' || !monthYearKey.includes('-')) return "Inválido";
            const parts = monthYearKey.split('-');
            return `${parts[1]}/${parts[0]}`;
        }


        function mostrarBotoesDiario() {
            const aluno = document.getElementById('diarioAluno').value.trim();
            const data = document.getElementById('diarioData').value;
            const conteudo = document.getElementById('diarioConteudo').value.trim();
            const camposPreenchidos = aluno && data && conteudo;
            const algumCampoPreenchido = aluno || data || conteudo;

            document.getElementById('btnDiarioAdd').style.display = camposPreenchidos && diarioEditIdx === null ? '' : 'none';
            document.getElementById('btnDiarioEdit').style.display = camposPreenchidos && diarioEditIdx !== null ? '' : 'none';
            document.getElementById('btnDiarioCancel').style.display = diarioEditIdx !== null ? '' : 'none';
            document.getElementById('btnDiarioLimpar').style.display = algumCampoPreenchido && diarioEditIdx === null ? '' : 'none';
        }

        function limparCamposDiario() {
            document.getElementById('formDiarioClasse').reset();
            diarioEditIdx = null;
            mostrarBotoesDiario();
        }

        function editarDiarioClasse(idx) {
            let lista = recuperarLocal('diarioClasseLista', []);
            if (idx < 0 || idx >= lista.length) { console.error("Índice inválido para editar diário:", idx); return; }
            const registro = lista[idx];
            document.getElementById('diarioAluno').value = registro.aluno;
            document.getElementById('diarioData').value = registro.data;
            document.getElementById('diarioConteudo').value = registro.conteudo;
            diarioEditIdx = idx;
            mostrarBotoesDiario();
            fecharModalDiario(); // Close modal to edit on main form
            document.getElementById('diarioAluno').focus();
        }

        function removerDiarioClasse(idx) {
            if (!confirm('Excluir este registro do diário?')) return;
            let lista = recuperarLocal('diarioClasseLista', []);
            if (idx < 0 || idx >= lista.length) { console.error("Índice inválido para remover do diário:", idx); return; }
            lista.splice(idx, 1);
            salvarLocal('diarioClasseLista', lista);
            if (diarioEditIdx === idx) limparCamposDiario(); // Reset form if editing this item
            else if (diarioEditIdx !== null && idx < diarioEditIdx) diarioEditIdx--; // Adjust edit index if an earlier item was removed
            
            if (document.getElementById('modalDiario').classList.contains('active')) filtrarModalDiario(); // Refresh modal if open
        }

        function confirmarEdicaoDiarioClasse() { salvarDiarioClasse(); }
        function cancelarEdicaoDiarioClasse() { limparCamposDiario(); }

        function salvarDiarioClasse() {
            const aluno = document.getElementById('diarioAluno').value.trim();
            const data = document.getElementById('diarioData').value;
            const conteudo = document.getElementById('diarioConteudo').value.trim();

            if (!aluno || !data || !conteudo) { alert('Preencha todos os campos do diário.'); return; }

            let lista = recuperarLocal('diarioClasseLista', []);
            if (diarioEditIdx !== null) { // Editing existing
                if (diarioEditIdx >= 0 && diarioEditIdx < lista.length) {
                    lista[diarioEditIdx] = { aluno, data, conteudo };
                    alert('Registro do diário atualizado com sucesso!');
                } else {
                    console.error("Índice de edição do diário inválido:", diarioEditIdx);
                    limparCamposDiario(); // Reset state
                    return;
                }
            } else { // Adding new
                lista.push({ aluno, data, conteudo });
                alert('Registro do diário salvo com sucesso!');
            }
            salvarLocal('diarioClasseLista', lista);
            limparCamposDiario();
            if (document.getElementById('modalDiario').classList.contains('active')) filtrarModalDiario();
        }
        
        function abrirModalDiario() {
            document.getElementById('modalDiario').classList.add('active');
            document.getElementById('filtroNome').value = ''; // Clear filters
            document.getElementById('filtroData').value = '';
            filtrarModalDiario(); // Initial population
        }
        function fecharModalDiario() { document.getElementById('modalDiario').classList.remove('active'); }

        document.addEventListener('input', function(e) {
            if ((e.target.id === 'filtroNome' || e.target.id === 'filtroData') && document.getElementById('modalDiario').classList.contains('active')) {
                filtrarModalDiario();
            }
        });
        
        function filtrarModalDiario() {
            let listaOriginal = recuperarLocal('diarioClasseLista', []);
            // Create a map of original items to their original indices
            const listaComIndices = listaOriginal.map((item, index) => ({ ...item, originalIndex: index }));

            const filtroNome = document.getElementById('filtroNome').value.trim().toLowerCase();
            const filtroData = document.getElementById('filtroData').value;

            let filtrados = listaComIndices.filter(reg =>
                (!filtroNome || String(reg.aluno || '').toLowerCase().includes(filtroNome)) &&
                (!filtroData || reg.data === filtroData)
            );

            let html = `<table><thead><tr><th>Data</th><th>Aluno</th><th>Conteúdo</th><th>Ações</th></tr></thead><tbody>`;
            if (filtrados.length) {
                filtrados.slice().reverse().forEach(reg => { // Display newest first
                    const alunoHtml = String(reg.aluno || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const conteudoHtml = String(reg.conteudo || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    html += `<tr><td>${reg.data ? reg.data.split('-').reverse().join('/') : ''}</td><td>${alunoHtml}</td><td>${conteudoHtml}</td>
                        <td class="table-actions"><button onclick="editarDiarioClasse(${reg.originalIndex})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="removerDiarioClasse(${reg.originalIndex})" title="Remover"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } else { html += `<tr><td colspan="4" style="text-align:center;color:#bff;">Nenhum registro encontrado.</td></tr>`; }
            html += `</tbody></table>`;
            document.getElementById('conteudoModalDiario').innerHTML = html;
        }

        function mostrarBotoesFinanceiro() {
            const nome = document.getElementById('nomeFinanceiro').value.trim();
            const valor = document.getElementById('valorFinanceiro').value.trim();
            const camposPreenchidos = nome && valor;
            const isEditing = finEditIdx !== null;

            document.getElementById('btnFinAdd').style.display = camposPreenchidos && !isEditing ? '' : 'none';
            document.getElementById('btnFinEdit').style.display = camposPreenchidos && isEditing ? '' : 'none';
            document.getElementById('btnFinCancel').style.display = isEditing ? '' : 'none';
            document.getElementById('btnFinLimpar').style.display = (nome || valor) && !isEditing ? '' : 'none';
        }

        function adicionarFinanceiro() {
            const nome = document.getElementById('nomeFinanceiro').value.trim();
            const valor = document.getElementById('valorFinanceiro').value.trim();
            const status = document.getElementById('statusFinanceiro').value;
            const tipo = document.getElementById('tipoFinanceiro').value;

            if (!nome || !valor) { alert('Preencha nome/descrição e valor.'); return; }
            if (isNaN(parseFloat(valor))) { alert('O valor financeiro é inválido.'); return; }

            let controleFinanceiroData = recuperarLocal('controleFinanceiro', {}); // Object of months
            let monthToUpdateDisplay;

            if (finEditIdx !== null) { // Editing
                const { monthKey, index } = finEditIdx;
                if (controleFinanceiroData[monthKey] && controleFinanceiroData[monthKey][index]) {
                    controleFinanceiroData[monthKey][index] = { nome, valor, status, tipo };
                    alert('Lançamento financeiro atualizado.');
                    monthToUpdateDisplay = monthKey;
                } else {
                    console.error("Erro ao encontrar lançamento para edição:", finEditIdx);
                    alert("Erro ao atualizar lançamento.");
                    limparFinanceiroCampos();
                    return;
                }
            } else { // Adding new
                const currentMonthKey = getCurrentMonthYearKey(); // YYYY-MM
                if (!controleFinanceiroData[currentMonthKey]) controleFinanceiroData[currentMonthKey] = [];
                controleFinanceiroData[currentMonthKey].push({ nome, valor, status, tipo });
                alert('Novo lançamento financeiro adicionado.');
                monthToUpdateDisplay = currentMonthKey;
            }

            salvarLocal('controleFinanceiro', controleFinanceiroData);
            limparFinanceiroCampos();
            
            if (document.getElementById('modalFinanceiro').classList.contains('active')) {
                financeiroSelecionadoMesAno = monthToUpdateDisplay; // Set current month for display
                populateMesAnoSelectFinanceiro(); // Repopulate and set selected
                renderizarConteudoModalFinanceiro(monthToUpdateDisplay); // Render the updated month
            }
        }

        function editarFinanceiro(monthKey, itemIndex) {
            let controleFinanceiroData = recuperarLocal('controleFinanceiro', {});
            const lancamento = controleFinanceiroData[monthKey] && controleFinanceiroData[monthKey][itemIndex];
            
            if (!lancamento) {
                console.error("Lançamento financeiro não encontrado para edição:", monthKey, itemIndex);
                alert("Lançamento não encontrado.");
                return;
            }
            document.getElementById('nomeFinanceiro').value = lancamento.nome;
            document.getElementById('valorFinanceiro').value = lancamento.valor;
            document.getElementById('statusFinanceiro').value = lancamento.status;
            document.getElementById('tipoFinanceiro').value = lancamento.tipo;
            finEditIdx = { monthKey: monthKey, index: itemIndex };
            mostrarBotoesFinanceiro();
            fecharModalFinanceiro();
            document.getElementById('nomeFinanceiro').focus();
        }

        function removerFinanceiro(monthKey, itemIndex) {
            if (!confirm('Excluir este lançamento financeiro?')) return;
            let controleFinanceiroData = recuperarLocal('controleFinanceiro', {});
            if (!controleFinanceiroData[monthKey] || !controleFinanceiroData[monthKey][itemIndex]) {
                console.error("Lançamento financeiro não encontrado para remoção:", monthKey, itemIndex);
                alert("Lançamento não encontrado.");
                return;
            }
            controleFinanceiroData[monthKey].splice(itemIndex, 1);
            // If the month array becomes empty, consider removing the monthKey or leaving it
            // if (controleFinanceiroData[monthKey].length === 0) delete controleFinanceiroData[monthKey];
            salvarLocal('controleFinanceiro', controleFinanceiroData);

            if (finEditIdx && finEditIdx.monthKey === monthKey && finEditIdx.index === itemIndex) {
                limparFinanceiroCampos(); // Reset form if editing this item
            } else if (finEditIdx && finEditIdx.monthKey === monthKey && itemIndex < finEditIdx.index) {
                finEditIdx.index--; // Adjust edit index
            }
            
            if (document.getElementById('modalFinanceiro').classList.contains('active')) {
                populateMesAnoSelectFinanceiro(); // Month list might change if a month becomes empty
                renderizarConteudoModalFinanceiro(financeiroSelecionadoMesAno); // Re-render current view
            }
        }
        
        function confirmarEdicaoFinanceiro() { adicionarFinanceiro(); }
        function limparFinanceiroCampos() {
            document.getElementById('formFinanceiro').reset();
            finEditIdx = null; mostrarBotoesFinanceiro();
        }
        function cancelarEdicaoFinanceiro() { limparFinanceiroCampos(); }

        function getAllMonthKeysSorted(financeiroData) {
            return Object.keys(financeiroData).sort((a, b) => { // Sort YYYY-MM descending
                const dateA = new Date(a.substring(0,4), parseInt(a.substring(5,7)) - 1);
                const dateB = new Date(b.substring(0,4), parseInt(b.substring(5,7)) - 1);
                return dateB - dateA;
            });
        }
        
        function populateMesAnoSelectFinanceiro() {
            const selectElement = document.getElementById('mesAnoSelectFinanceiro');
            const currentValue = selectElement.value; // Preserve current selection if still valid
            selectElement.innerHTML = ''; // Clear existing options

            const controleFinanceiroData = recuperarLocal('controleFinanceiro', {});
            let monthKeys = getAllMonthKeysSorted(controleFinanceiroData); // Get sorted existing keys

            const currentMonthKey = getCurrentMonthYearKey();
            // Ensure current month is an option, even if no data exists for it yet
            if (!monthKeys.includes(currentMonthKey)) {
                monthKeys.push(currentMonthKey);
                // Re-sort if currentMonthKey was added
                 monthKeys = monthKeys.sort((a,b) => new Date(b.substring(0,4), parseInt(b.substring(5,7))-1) - new Date(a.substring(0,4), parseInt(a.substring(5,7))-1));
            }
            
            if (monthKeys.length === 0) { // Should not happen if currentMonthKey is always added
                 monthKeys.push(currentMonthKey); // Failsafe
            }

            monthKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key; option.textContent = monthYearKeyToDisplay(key);
                selectElement.appendChild(option);
            });

            // Restore selection or set a default
            if (currentValue && monthKeys.includes(currentValue)) {
                selectElement.value = currentValue;
            } else if (financeiroSelecionadoMesAno && monthKeys.includes(financeiroSelecionadoMesAno)) {
                selectElement.value = financeiroSelecionadoMesAno;
            } else if (monthKeys.length > 0) { // Default to the most recent month with data or current month
                selectElement.value = monthKeys[0];
            }
            financeiroSelecionadoMesAno = selectElement.value; // Sync global state
        }


        function renderizarConteudoModalFinanceiro(monthKey) { // monthKey is 'YYYY-MM'
            financeiroSelecionadoMesAno = monthKey; // Update global state
            const selectElement = document.getElementById('mesAnoSelectFinanceiro');
            if(selectElement.value !== monthKey) selectElement.value = monthKey; // Sync dropdown

            const controleFinanceiroData = recuperarLocal('controleFinanceiro', {});
            const lancamentosDoMesOrig = controleFinanceiroData[monthKey] || [];
            // Sort by name for display, but preserve original index for editing/deleting
            const lancamentosDoMes = lancamentosDoMesOrig.map((item, index) => ({...item, originalIndex: index}))
                                      .sort((a, b) => 
                                        String(a.nome || '').toLowerCase().localeCompare(String(b.nome || '').toLowerCase(), 'pt-BR', {sensitivity: 'base'})
                                      );

            let totalPago = 0, totalAReceber = 0;
            lancamentosDoMesOrig.forEach(item => { // Calculate totals from original unsorted list for accuracy
                const valorItem = parseFloat(item.valor) || 0;
                if (item.status === 'Pago') totalPago += valorItem; else totalAReceber += valorItem;
            });

            let somatorioHtml = `<div style="padding:10px 5px;margin-bottom:15px;background:#102b1f;border-radius:8px;text-align:center;border:1px solid var(--c-green);"><p style="margin:8px 0;font-size:1.08em;color:var(--txt);"><strong>Total Pago (Mês):</strong> <span style="color:var(--c-green);font-weight:bold;">${formatarMoeda(totalPago)}</span></p><p style="margin:8px 0;font-size:1.08em;color:var(--txt);"><strong>Total a Receber (Mês):</strong> <span style="color:var(--c-yellow);font-weight:bold;">${formatarMoeda(totalAReceber)}</span></p></div>`;
            
            let tabelaHtml = `<table><thead><tr><th>Nome/Descrição</th><th>Valor</th><th>Status</th><th>Tipo</th><th>Ações</th></tr></thead><tbody>`;
            if (lancamentosDoMes.length) {
                lancamentosDoMes.forEach(item => {
                    // const idxNaListaOriginal = lancamentosDoMesOrig.findIndex(orig => orig === item); // Not needed if using item.originalIndex from map
                    const nomeHtml = String(item.nome || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const valorFormatado = formatarMoeda(item.valor);
                    const statusHtml = String(item.status || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const tipoHtml = String(item.tipo || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");

                    tabelaHtml += `<tr><td style="text-align:left;padding-left:10px;">${nomeHtml}</td><td style="text-align:center;">${valorFormatado}</td>
                        <td style="text-align:center;color:${item.status === 'Pago' ? 'var(--c-green)' : 'var(--c-yellow)'};">${statusHtml}</td>
                        <td style="text-align:center;">${tipoHtml}</td><td class="table-actions">
                        <button onclick="editarFinanceiro('${monthKey}', ${item.originalIndex})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="removerFinanceiro('${monthKey}', ${item.originalIndex})" title="Remover"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } else { tabelaHtml += `<tr><td colspan="5" style="text-align:center;color:#bff;">Nenhum lançamento para ${monthYearKeyToDisplay(monthKey)}.</td></tr>`; }
            tabelaHtml += `</tbody></table>`;
            document.getElementById('conteudoModalFinanceiro').innerHTML = somatorioHtml + tabelaHtml;
        }

        function atualizarModalFinanceiroComMesSelecionado() {
            const selectedMonthKey = document.getElementById('mesAnoSelectFinanceiro').value;
            renderizarConteudoModalFinanceiro(selectedMonthKey);
        }

        function navegarMesFinanceiro(offset) {
            const selectElement = document.getElementById('mesAnoSelectFinanceiro');
            const currentIndex = selectElement.selectedIndex;
            const newIndex = currentIndex + offset;
            if (newIndex >= 0 && newIndex < selectElement.options.length) {
                selectElement.selectedIndex = newIndex;
                atualizarModalFinanceiroComMesSelecionado();
            }
        }
        
        function irParaMesAtualFinanceiro() {
            const currentMonthKey = getCurrentMonthYearKey();
            const selectElement = document.getElementById('mesAnoSelectFinanceiro');
            // Repopulate to ensure current month is an option and sorted correctly
            populateMesAnoSelectFinanceiro(); 
            
            if (Array.from(selectElement.options).some(opt => opt.value === currentMonthKey)) {
                selectElement.value = currentMonthKey;
            } else if (selectElement.options.length > 0) { // Fallback if current month somehow isn't there
                selectElement.value = selectElement.options[0].value; 
            }
            renderizarConteudoModalFinanceiro(selectElement.value);
        }

        function abrirModalFinanceiro() {
            populateMesAnoSelectFinanceiro(); // Ensure dropdown is up-to-date

            const currentMonthKey = getCurrentMonthYearKey();
            const controleFinanceiroData = recuperarLocal('controleFinanceiro', {});
            const allMonthsWithData = getAllMonthKeysSorted(controleFinanceiroData);

            let targetMonth = financeiroSelecionadoMesAno; // Try to stick to previously selected month

            if (!targetMonth || (!allMonthsWithData.includes(targetMonth) && targetMonth !== currentMonthKey) ) { // If not valid or not current
                if (allMonthsWithData.includes(currentMonthKey)) targetMonth = currentMonthKey; // Prefer current month if it has data
                else if (allMonthsWithData.length > 0) targetMonth = allMonthsWithData[0]; // Most recent month with data
                else targetMonth = currentMonthKey; // Default to current month (even if no data)
            }
            
            financeiroSelecionadoMesAno = targetMonth; // Set the global state
            document.getElementById('mesAnoSelectFinanceiro').value = financeiroSelecionadoMesAno; // Set dropdown
            renderizarConteudoModalFinanceiro(financeiroSelecionadoMesAno);
            document.getElementById('modalFinanceiro').classList.add('active');
        }
        function fecharModalFinanceiro() { document.getElementById('modalFinanceiro').classList.remove('active'); }


        function mostrarBotoesAluno() {
            const nome = document.getElementById('nomeAluno').value.trim();
            const anydesk = document.getElementById('anydeskAluno').value.trim();
            const showAdd = nome && anydesk && alunoEditIdx === null;
            const showEdit = nome && anydesk && alunoEditIdx !== null;
            const showAnyButton = nome || anydesk;

            document.getElementById('btnAlunoAdd').style.display = showAdd ? '' : 'none';
            document.getElementById('btnAlunoEdit').style.display = showEdit ? '' : 'none';
            document.getElementById('btnAlunoCancel').style.display = alunoEditIdx !== null ? '' : 'none';
            document.getElementById('btnAlunoLimpar').style.display = showAnyButton && alunoEditIdx === null ? '' : 'none';
        }
        
        function adicionarAluno() {
            const nome = document.getElementById('nomeAluno').value.trim();
            const anydesk = document.getElementById('anydeskAluno').value.trim();
            if (!nome || !anydesk) { alert('Preencha nome e AnyDesk do aluno.'); return; }

            let lista = recuperarLocal('alunosAnyDesk', []);
            // Check for duplicates only if adding new, or if editing and the new combination already exists for a *different* student
            const alunoExistente = lista.find((al, index) => 
                al.nome.toLowerCase() === nome.toLowerCase() && 
                al.anydesk === anydesk &&
                (alunoEditIdx === null || alunoEditIdx !== index) // If editing, ignore the current student being edited
            );

            if (alunoExistente) {
                 alert('Um aluno já está cadastrado com este nome e AnyDesk.');
                 return;
            }

            if (alunoEditIdx === null) { // Adding new
                lista.push({ nome, anydesk }); alert('Aluno cadastrado com sucesso!');
            } else { // Editing existing
                if (alunoEditIdx >= 0 && alunoEditIdx < lista.length) {
                    lista[alunoEditIdx] = { nome, anydesk }; alert('Dados do aluno atualizados com sucesso!');
                } else {
                    console.error("Índice de edição de aluno inválido:", alunoEditIdx);
                    limparAlunoCamposComPesquisa(); return;
                }
            }
            salvarLocal('alunosAnyDesk', lista);
            limparAlunoCamposComPesquisa();
            if (document.getElementById('modalAlunos').classList.contains('active')) abrirModalAlunos(); // Refresh modal
        }

        function editarAluno(idx) {
            let lista = recuperarLocal('alunosAnyDesk', []);
            if (idx < 0 || idx >= lista.length) { console.error("Índice inválido para editar aluno:", idx); return; }
            document.getElementById('nomeAluno').value = lista[idx].nome;
            document.getElementById('anydeskAluno').value = lista[idx].anydesk;
            alunoEditIdx = idx; mostrarBotoesAluno(); fecharModalAlunos();
            limparResultadosPesquisaAlunos(); document.getElementById('nomeAluno').focus();
        }
        function confirmarEdicaoAluno() { adicionarAluno(); }
        function cancelarEdicaoAlunoComPesquisa() { limparAlunoCamposComPesquisa(); }

        function removerAluno(idx) {
            if (!confirm('Excluir este aluno?')) return;
            let lista = recuperarLocal('alunosAnyDesk', []);
            if (idx < 0 || idx >= lista.length) { console.error("Índice inválido para remover aluno:", idx); return; }
            lista.splice(idx,1); salvarLocal('alunosAnyDesk', lista);
            if (alunoEditIdx === idx) limparAlunoCamposComPesquisa();
            else if (alunoEditIdx !== null && idx < alunoEditIdx) alunoEditIdx--;
            if (document.getElementById('modalAlunos').classList.contains('active')) abrirModalAlunos();
        }
                
        function limparAlunoCamposComPesquisa() {
            document.getElementById('nomeAluno').value = '';
            document.getElementById('anydeskAluno').value = '';
            alunoEditIdx = null; limparResultadosPesquisaAlunos(); mostrarBotoesAluno();
        }
        
        function pesquisarAlunosNoCard(termo) {
            const listaResultadosDiv = document.getElementById('listaResultadosPesquisaAlunos');
            if (!termo.trim()) { listaResultadosDiv.innerHTML = ''; return; }
            const alunos = recuperarLocal('alunosAnyDesk', []);
            const termoNormalizado = termo.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Normalize for search
            
            const resultadosFiltrados = alunos.filter(aluno => 
                String(aluno.nome || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(termoNormalizado)
            ).sort((a,b) => String(a.nome).localeCompare(String(b.nome), 'pt-BR', {sensitivity: 'base'})); // Sort results

            listaResultadosDiv.innerHTML = '';
            resultadosFiltrados.slice(0, 7).forEach(aluno => { // Limit results shown
                const divItem = document.createElement('div');
                divItem.textContent = aluno.nome;
                divItem.onclick = () => selecionarAlunoPesquisado(aluno);
                listaResultadosDiv.appendChild(divItem);
            });
        }

        function selecionarAlunoPesquisado(aluno) {
            document.getElementById('nomeAluno').value = aluno.nome;
            document.getElementById('anydeskAluno').value = aluno.anydesk;
            limparResultadosPesquisaAlunos(); mostrarBotoesAluno();
        }

        function limparResultadosPesquisaAlunos() {
            document.getElementById('listaResultadosPesquisaAlunos').innerHTML = '';
        }

        function abrirModalAlunos() {
            let listaOriginal = recuperarLocal('alunosAnyDesk', []);
            // Map to include originalIndex before sorting for display
            const listaComIndices = listaOriginal.map((aluno, index) => ({ ...aluno, originalIndex: index }));
            listaComIndices.sort((a,b) => String(a.nome||'').localeCompare(String(b.nome||''), 'pt-BR', {sensitivity:'base'})); // Sort for display

            let html = `<table><thead><tr><th>Nome</th><th>AnyDesk</th><th style="text-align:center;">Ações</th></tr></thead><tbody>`;
            if(listaComIndices.length){
                listaComIndices.forEach(item => {
                    const nomeHtml = String(item.nome || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const anydeskHtml = String(item.anydesk || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    html += `<tr><td style="text-align:left;padding-left:10px;">${nomeHtml}</td><td style="text-align:center;">${anydeskHtml}</td>
                        <td class="table-actions" style="text-align:center;"><button onclick="editarAluno(${item.originalIndex})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="removerAluno(${item.originalIndex})" title="Remover"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } else { html += `<tr><td colspan="3" style="text-align:center;color:#bff;">Nenhum aluno cadastrado.</td></tr>`; }
            html += `</tbody></table>`;
            document.getElementById('conteudoModalAlunos').innerHTML = html;
            document.getElementById('modalAlunos').classList.add('active');
        }
        function fecharModalAlunos() { document.getElementById('modalAlunos').classList.remove('active'); }


        function mostrarBotoesAnotacao() {
            const val = document.getElementById('anotacaoInput').value.trim();
            const isEditing = anotacaoEditIdx !== null;
            document.getElementById('btnAddAnotacao').style.display = val && !isEditing ? '' : 'none';
            document.getElementById('btnEditAnotacao').style.display = val && isEditing ? '' : 'none';
            document.getElementById('btnCancelEditAnotacao').style.display = isEditing ? '' : 'none';
            document.getElementById('btnLimparAnotacao').style.display = val && !isEditing ? '' : 'none';
        }

        function salvarOuAtualizarAnotacao() {
            const val = document.getElementById('anotacaoInput').value.trim(); if (!val) return;
            let anotacoes = recuperarLocal('anotacoesRapidas', []);
            if (anotacaoEditIdx !== null) { // Editing
                if (anotacaoEditIdx>=0 && anotacaoEditIdx<anotacoes.length) anotacoes[anotacaoEditIdx]=val;
                else console.error("Índice de edição de anotação inválido:", anotacaoEditIdx);
            } else { // Adding new
                anotacoes.push(val); 
            }
            salvarLocal('anotacoesRapidas', anotacoes); limparAnotacaoCampos(); listarAnotacoes();
        }

        function editarAnotacao(idxExibicao) { // idxExibicao is based on reversed list
            let anotacoes = recuperarLocal('anotacoesRapidas', []);
            // Convert display index (from reversed list) to original array index
            let originalIndex = anotacoes.length - 1 - idxExibicao; 

            if (originalIndex>=0 && originalIndex<anotacoes.length) {
                document.getElementById('anotacaoInput').value = anotacoes[originalIndex];
                anotacaoEditIdx = originalIndex; mostrarBotoesAnotacao(); document.getElementById('anotacaoInput').focus();
            } else { console.error("Índice inválido para editar anotação:", idxExibicao, originalIndex); limparAnotacaoCampos(); }
        }
        
        function cancelarEdicaoAnotacao() { limparAnotacaoCampos(); }
        
        function removerAnotacao(idxExibicao) { // idxExibicao is based on reversed list
            if (!confirm('Excluir anotação?')) return;
            let anotacoes = recuperarLocal('anotacoesRapidas', []);
            let originalIndexToRemove = anotacoes.length - 1 - idxExibicao;

            if (originalIndexToRemove>=0 && originalIndexToRemove<anotacoes.length) {
                if (anotacaoEditIdx === originalIndexToRemove) limparAnotacaoCampos(); // Clear form if editing this item
                anotacoes.splice(originalIndexToRemove, 1); salvarLocal('anotacoesRapidas', anotacoes); listarAnotacoes();
                // Adjust edit index if an earlier item (in original array order) was removed
                if (anotacaoEditIdx !== null && originalIndexToRemove < anotacaoEditIdx) anotacaoEditIdx--;
            } else { console.error("Índice inválido para remover anotação:", idxExibicao); }
        }
        function limparAnotacaoCampos() {
            document.getElementById('anotacaoInput').value = '';
            anotacaoEditIdx = null; mostrarBotoesAnotacao();
        }
        function listarAnotacoes() {
            let anotacoes = recuperarLocal('anotacoesRapidas', []);
            let tbody = document.getElementById('tabelaAnotacoes').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
            if (Array.isArray(anotacoes)) {
                anotacoes.slice().reverse().forEach((a, idxExibicao) => { // Iterate reversed for display (newest first)
                    const anotacaoHtml = String(a || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    // idxExibicao is now the index in the reversed list, pass this to edit/remove functions
                    tbody.innerHTML += `<tr><td>${anotacaoHtml}</td><td class="table-actions" style="text-align:center;">
                        <button onclick="editarAnotacao(${idxExibicao})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="removerAnotacao(${idxExibicao})" title="Remover"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } else { 
                console.error("Dados de anotações inválidos. Resetando para array vazio.", anotacoes); 
                salvarLocal('anotacoesRapidas', []); 
            }
        }

        document.addEventListener('keydown', function(e){
            if(e.key === "Escape") {
                if (document.getElementById('modalDiario').classList.contains('active')) fecharModalDiario();
                if (document.getElementById('modalFinanceiro').classList.contains('active')) fecharModalFinanceiro();
                if (document.getElementById('modalAlunos').classList.contains('active')) fecharModalAlunos();
                
                if (diarioEditIdx !== null) cancelarEdicaoDiarioClasse();
                if (alunoEditIdx !== null) cancelarEdicaoAlunoComPesquisa();
                if (finEditIdx !== null) cancelarEdicaoFinanceiro();
                if (anotacaoEditIdx !== null) cancelarEdicaoAnotacao();
                
                limparResultadosPesquisaAlunos(); // Clear any open search results
            }
        });

        function exportarDados() {
            const dados = {
                diarioClasseLista: recuperarLocal('diarioClasseLista', []),
                alunosAnyDesk: recuperarLocal('alunosAnyDesk', []),
                anotacoesRapidas: recuperarLocal('anotacoesRapidas', []),
                controleFinanceiro: recuperarLocal('controleFinanceiro', {}) // Ensure it's an object
            };
            const blob = new Blob([JSON.stringify(dados, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob); const a = document.createElement("a");
            a.href = url; const timestamp = new Date().toISOString().slice(0,19).replace(/[-:T]/g,"");
            a.download = `dashboard_rs_tech_backup_${timestamp}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            alert('Dados exportados com sucesso!');
        }

        function importarDados(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);
                    if (typeof dadosImportados !== "object" || dadosImportados === null) throw new Error("Formato de arquivo inválido!");

                    // Validate and save each data piece
                    if (Array.isArray(dadosImportados.diarioClasseLista)) salvarLocal('diarioClasseLista', dadosImportados.diarioClasseLista);
                    else if ("diarioClasseLista" in dadosImportados) salvarLocal('diarioClasseLista', []); // Key exists but not array, save empty

                    if (Array.isArray(dadosImportados.alunosAnyDesk)) salvarLocal('alunosAnyDesk', dadosImportados.alunosAnyDesk);
                    else if ("alunosAnyDesk" in dadosImportados) salvarLocal('alunosAnyDesk', []);
                    
                    if (Array.isArray(dadosImportados.anotacoesRapidas)) salvarLocal('anotacoesRapidas', dadosImportados.anotacoesRapidas);
                    else if ("anotacoesRapidas" in dadosImportados) salvarLocal('anotacoesRapidas', []);

                    // controleFinanceiro should be an object, not an array
                    if (typeof dadosImportados.controleFinanceiro==="object" && dadosImportados.controleFinanceiro!==null && !Array.isArray(dadosImportados.controleFinanceiro))
                        salvarLocal('controleFinanceiro', dadosImportados.controleFinanceiro);
                    else if ("controleFinanceiro" in dadosImportados) salvarLocal('controleFinanceiro', {}); // Key exists but invalid type
                    
                    // Reset forms and refresh views
                    limparCamposDiario(); limparAlunoCamposComPesquisa(); limparFinanceiroCampos(); limparAnotacaoCampos();
                    listarAnotacoes(); // This updates the quick notes table
                    
                    alert("Dados importados com sucesso!");
                } catch (err) { alert("Falha na importação: " + err.message);
                } finally {
                    // Refresh any open modals or necessary UI parts
                    if (document.getElementById('modalDiario').classList.contains('active')) filtrarModalDiario();
                    if (document.getElementById('modalAlunos').classList.contains('active')) abrirModalAlunos();
                    if (document.getElementById('modalFinanceiro').classList.contains('active')) {
                        financeiroSelecionadoMesAno = ''; // Reset selected month to allow re-evaluation
                        abrirModalFinanceiro(); 
                    }
                    // Ensure button states are correct after potential data changes
                    mostrarBotoesDiario(); mostrarBotoesAluno(); mostrarBotoesFinanceiro(); mostrarBotoesAnotacao();
                }
            };
            reader.readAsText(file); event.target.value = ""; // Reset file input
        }
                
        function setAnoAtualFooter() {
            const ano = new Date().getFullYear();
            const footerSpan = document.getElementById('anoAtualFooter'); // Target the span
            if (footerSpan) { 
                 footerSpan.textContent = ano; // Set only the year in the span
            } else { // Fallback if span is not there for some reason
                const footerElement = document.querySelector('footer');
                if (footerElement) footerElement.textContent = `RS TECH ${ano}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            limparCamposDiario(); limparAlunoCamposComPesquisa(); limparFinanceiroCampos(); limparAnotacaoCampos();
            listarAnotacoes(); 
            setAnoAtualFooter();

            // Initialize financeiroSelecionadoMesAno correctly on load
            const currentFinMonth = getCurrentMonthYearKey();
            const finData = recuperarLocal('controleFinanceiro', {});
            const sortedFinMonths = getAllMonthKeysSorted(finData);

            if (sortedFinMonths.includes(currentFinMonth)) financeiroSelecionadoMesAno = currentFinMonth;
            else if (sortedFinMonths.length > 0) financeiroSelecionadoMesAno = sortedFinMonths[0]; // Most recent with data
            else financeiroSelecionadoMesAno = currentFinMonth; // Default to current month

            // Global click listener to close student search results
            document.addEventListener('click', function(event) {
                const searchResultsDiv = document.getElementById('listaResultadosPesquisaAlunos');
                const nomeAlunoInput = document.getElementById('nomeAluno');
                // If click is outside the search results and not on the input itself
                if (searchResultsDiv && nomeAlunoInput && 
                    !searchResultsDiv.contains(event.target) && 
                    event.target !== nomeAlunoInput) {
                    limparResultadosPesquisaAlunos();
                }
            });
        });
    </script>
</body>
</html>
